<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta name="theme-color" content="#050d14"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="Weltkind"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="apple-touch-icon" href="icons/icon-192.png"/>
  <link rel="icon" href="icons/icon-192.png"/>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet"/>
  <title>Weltkind</title>
  <style>
    :root {
      --bg:#050d14; --surface:#0a1929; --card:#0d2137;
      --accent:#00e676; --accent2:#00b0ff; --warn:#ff6d00;
      --text:#e0f7fa; --muted:#546e7a; --border:rgba(0,230,118,.12);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;overflow:hidden;background:var(--bg);font-family:'Rajdhani',sans-serif;color:var(--text)}

    /* ‚îÄ‚îÄ Splash ‚îÄ‚îÄ */
    #bg-canvas{position:fixed;inset:0;z-index:0;opacity:.3}
    #splash{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .6s ease}
    #splash.out{opacity:0;pointer-events:none}
    .vpn-orb{position:relative;width:140px;height:140px;margin-bottom:28px}
    .orb-core{position:absolute;inset:30px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#00e676,#005f2d);box-shadow:0 0 40px rgba(0,230,118,.8);animation:op 2.5s ease-in-out infinite}
    .orb-ring{position:absolute;inset:0;border-radius:50%;border:2px solid rgba(0,230,118,.5);animation:re 2.5s ease-out infinite}
    .orb-ring:nth-child(2){animation-delay:.8s}
    .orb-ring:nth-child(3){animation-delay:1.6s}
    @keyframes op{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
    @keyframes re{0%{transform:scale(.6);opacity:.8}100%{transform:scale(1.7);opacity:0}}
    .splash-brand{font-size:2.2rem;font-weight:700;letter-spacing:.08em;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .splash-sub{margin-top:8px;font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--muted);letter-spacing:.15em}
    .splash-bar{margin-top:32px;width:160px;height:2px;background:rgba(0,230,118,.12);border-radius:2px;overflow:hidden}
    .splash-bar-fill{height:100%;width:0%;background:var(--accent);border-radius:2px;animation:bf 2.2s ease forwards}
    @keyframes bf{to{width:100%}}

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    #hdr{position:fixed;top:0;left:0;right:0;z-index:200;background:rgba(5,13,20,.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:0 12px;display:flex;align-items:center;justify-content:space-between;height:52px;gap:8px}
    .hdr-left{display:flex;align-items:center;gap:8px;flex-shrink:0}
    .hdr-brand{font-size:1.05rem;font-weight:700;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;white-space:nowrap}
    #ip-chip{display:flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;background:rgba(0,176,255,.06);border:1px solid rgba(0,176,255,.15);font-family:'JetBrains Mono',monospace;font-size:.58rem;color:var(--muted);transition:all .3s;cursor:default;white-space:nowrap;max-width:150px;overflow:hidden}
    #ip-chip.loaded{color:var(--accent2);border-color:rgba(0,176,255,.3)}
    #ip-flag{font-size:.85rem;line-height:1;flex-shrink:0}
    #ip-text{overflow:hidden;text-overflow:ellipsis}
    .hdr-right{display:flex;align-items:center;gap:8px;flex-shrink:0}
    .conn-pill{display:flex;align-items:center;gap:5px;padding:4px 9px;border-radius:20px;background:rgba(0,230,118,.08);border:1px solid rgba(0,230,118,.2);font-family:'JetBrains Mono',monospace;font-size:.6rem;color:var(--accent);cursor:pointer;transition:background .2s;white-space:nowrap}
    .conn-pill:hover{background:rgba(0,230,118,.15)}
    .conn-dot{width:6px;height:6px;border-radius:50%;background:var(--warn);transition:background .4s,box-shadow .4s;flex-shrink:0}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
    .conn-dot.blink{animation:blink 2s infinite}
    .bell-btn{position:relative;width:34px;height:34px;border-radius:10px;background:rgba(0,176,255,.08);border:1px solid rgba(0,176,255,.2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;transition:background .2s;flex-shrink:0}
    .bell-btn:hover{background:rgba(0,176,255,.2)}
    .bell-badge{position:absolute;top:3px;right:3px;width:8px;height:8px;background:var(--warn);border-radius:50%;border:1px solid var(--bg);display:none}
    .bell-badge.show{display:block}

    /* Offline bar */
    #offline-bar{position:fixed;top:52px;left:0;right:0;z-index:190;background:#b71c1c;color:#fff;font-family:'JetBrains Mono',monospace;font-size:.7rem;text-align:center;padding:5px;display:none;animation:slideDown .3s ease}
    #offline-bar.show{display:block}
    @keyframes slideDown{from{transform:translateY(-100%)}to{transform:translateY(0)}}

    /* ‚îÄ‚îÄ Frame + Pull-to-refresh ‚îÄ‚îÄ */
    #frame-wrap{position:fixed;top:52px;left:0;right:0;bottom:0;z-index:10;overflow:hidden}
    #pull-indicator{position:absolute;top:0;left:50%;transform:translateX(-50%) translateY(-60px);width:36px;height:36px;border-radius:50%;background:var(--card);border:1px solid var(--border);display:none;align-items:center;justify-content:center;font-size:1.1rem;z-index:20;pointer-events:none;opacity:0;transition:opacity .2s}
    @keyframes spin{to{transform:translateX(-50%) translateY(8px) rotate(360deg)}}
    #pull-indicator.spinning{animation:spin .6s linear infinite;display:flex}
    #main-frame{width:100%;height:100%;border:none;display:block;opacity:0;transition:opacity .5s}
    #main-frame.loaded{opacity:1}

    /* Offline page */
    #offline-page{position:absolute;inset:0;background:var(--bg);display:none;flex-direction:column;align-items:center;justify-content:center;gap:16px;z-index:15;padding:24px;text-align:center}
    #offline-page.show{display:flex}
    .offline-icon{font-size:3.5rem}
    .offline-title{font-size:1.4rem;font-weight:700}
    .offline-sub{font-family:'JetBrains Mono',monospace;font-size:.75rem;color:var(--muted);line-height:1.6}
    .offline-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px 20px;width:100%;max-width:320px;text-align:left}
    .offline-card-title{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--muted);text-transform:uppercase;margin-bottom:10px}
    .offline-row{display:flex;justify-content:space-between;font-size:.9rem;margin-bottom:6px}
    .offline-row:last-child{margin-bottom:0}
    .offline-val{font-weight:700;color:var(--accent)}
    .offline-val.warn{color:var(--warn)}
    .offline-val.err{color:#ff5252}
    .offline-retry{margin-top:8px;padding:10px 24px;background:linear-gradient(135deg,var(--accent),#00b300);border:none;border-radius:100px;color:#000;font-family:'Rajdhani',sans-serif;font-size:.95rem;font-weight:700;cursor:pointer}

    /* ‚îÄ‚îÄ Onboarding ‚îÄ‚îÄ */
    #onboarding{position:fixed;inset:0;z-index:8888;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 24px}
    #onboarding.done{display:none}
    .ob-slide{display:none;flex-direction:column;align-items:center;text-align:center;max-width:320px;width:100%}
    .ob-slide.active{display:flex;animation:fadeSlide .35s ease}
    @keyframes fadeSlide{from{opacity:0;transform:translateX(24px)}to{opacity:1;transform:translateX(0)}}
    .ob-emoji{font-size:4rem;margin-bottom:20px}
    .ob-title{font-size:1.5rem;font-weight:700;margin-bottom:14px;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .ob-desc{font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--muted);line-height:1.75;max-width:280px}
    .ob-desc strong{color:var(--text)}
    .ob-dots{display:flex;gap:8px;margin:28px 0 22px}
    .ob-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);transition:all .3s}
    .ob-dot.active{background:var(--accent);width:24px;border-radius:4px}
    .ob-btn{padding:13px 40px;background:linear-gradient(135deg,var(--accent),#00b300);border:none;border-radius:100px;color:#000;font-family:'Rajdhani',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;transition:transform .2s,box-shadow .2s}
    .ob-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,230,118,.35)}
    .ob-skip{background:none;border:none;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:.7rem;cursor:pointer;margin-top:14px;text-decoration:underline;padding:4px}

    /* ‚îÄ‚îÄ Panel ‚îÄ‚îÄ */
    #notif-panel{position:fixed;top:60px;right:12px;z-index:500;width:min(330px,92vw);background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 16px 48px rgba(0,0,0,.75);transform:translateY(-20px) scale(.95);opacity:0;pointer-events:none;transition:all .3s cubic-bezier(.34,1.56,.64,1);max-height:calc(100vh - 80px);overflow-y:auto}
    #notif-panel.open{transform:translateY(0) scale(1);opacity:1;pointer-events:all}
    .np-title{font-size:1rem;font-weight:700;margin-bottom:14px}
    .np-label{font-family:'JetBrains Mono',monospace;font-size:.63rem;color:var(--muted);letter-spacing:.1em;margin-bottom:6px;text-transform:uppercase}
    .np-section{margin-bottom:12px}
    .np-input{width:100%;padding:9px 12px;border-radius:9px;background:rgba(0,230,118,.05);border:1px solid var(--border);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.8rem;outline:none;transition:border .2s}
    .np-input:focus{border-color:var(--accent)}
    .np-btn{width:100%;padding:10px;border-radius:10px;border:none;font-family:'Rajdhani',sans-serif;font-size:.95rem;font-weight:700;cursor:pointer;transition:all .2s;margin-bottom:8px}
    .np-btn-green{background:linear-gradient(135deg,var(--accent),#00b300);color:#000}
    .np-btn-green:hover{box-shadow:0 0 20px rgba(0,230,118,.4);transform:translateY(-1px)}
    .np-btn-blue{background:rgba(0,176,255,.1);border:1px solid rgba(0,176,255,.25);color:var(--accent2)}
    .np-btn-purple{background:rgba(156,39,176,.1);border:1px solid rgba(156,39,176,.28);color:#ce93d8}
    .np-btn-red{background:rgba(255,23,68,.08);border:1px solid rgba(255,23,68,.25);color:#ff6b6b}

    /* Dashboard card */
    .dash-card{border-radius:14px;padding:14px 16px;margin-bottom:12px;border:1px solid var(--border);background:rgba(255,255,255,.03)}
    .dash-card.ok{border-color:rgba(0,230,118,.4);background:rgba(0,230,118,.05)}
    .dash-card.warn{border-color:rgba(255,109,0,.4);background:rgba(255,109,0,.05)}
    .dash-card.err{border-color:rgba(255,23,68,.4);background:rgba(255,23,68,.05)}
    .dc-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .dc-lbl{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .dc-badge{font-size:.75rem;font-weight:700;padding:2px 9px;border-radius:20px;background:rgba(0,230,118,.12);color:var(--accent)}
    .dash-card.warn .dc-badge{background:rgba(255,109,0,.12);color:var(--warn)}
    .dash-card.err .dc-badge{background:rgba(255,23,68,.12);color:#ff5252}
    .dc-days-num{font-size:2.6rem;font-weight:700;line-height:1;color:var(--accent);margin-bottom:2px}
    .dash-card.warn .dc-days-num{color:var(--warn)}
    .dash-card.err .dc-days-num{color:#ff5252}
    .dc-days-sub{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--muted)}
    .dc-meta{display:flex;gap:14px;margin-top:12px}
    .dc-meta-item{flex:1}
    .dc-meta-lbl{font-family:'JetBrains Mono',monospace;font-size:.6rem;color:var(--muted);text-transform:uppercase}
    .dc-meta-val{font-size:.82rem;font-weight:600;margin-top:2px}
    .sub-bar{height:3px;border-radius:2px;background:rgba(255,255,255,.07);margin-top:10px;overflow:hidden}
    .sub-bar-fill{height:100%;border-radius:2px;transition:width .8s ease,background .4s}
    .history-list{display:flex;flex-direction:column;gap:5px;margin-top:6px}
    .history-item{display:flex;justify-content:space-between;align-items:center;padding:7px 10px;border-radius:8px;background:rgba(0,230,118,.04);border:1px solid rgba(0,230,118,.08)}
    .history-date{font-family:'JetBrains Mono',monospace;font-size:.67rem;color:var(--muted)}
    .history-val{font-size:.75rem;color:var(--accent);font-weight:600}
    .np-hint{font-family:'JetBrains Mono',monospace;font-size:.66rem;color:var(--muted);text-align:center;margin:6px 0 10px;line-height:1.5}
    .np-divider{height:1px;background:var(--border);margin:10px 0}
    .np-status{font-family:'JetBrains Mono',monospace;font-size:.72rem;margin-top:8px;padding:8px 10px;border-radius:8px;background:rgba(0,230,118,.05);border:1px solid var(--border);display:none}
    .np-status.show{display:block}
    .np-status.ok{color:var(--accent);border-color:rgba(0,230,118,.3)}
    .np-status.warn{color:var(--warn);border-color:rgba(255,109,0,.3)}
    .np-status.err{color:#ff1744;border-color:rgba(255,23,68,.3)}

    /* Install banner */
    #install-banner{display:none;position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:var(--card);border:1px solid rgba(0,230,118,.25);border-radius:14px;padding:12px 16px;flex-direction:row;align-items:center;gap:12px;z-index:400;box-shadow:0 8px 32px rgba(0,0,0,.6);min-width:260px;max-width:90vw;animation:su .4s cubic-bezier(.34,1.56,.64,1)}
    @keyframes su{from{transform:translateX(-50%) translateY(80px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
    #install-banner.show{display:flex}
    .ib-icon{font-size:1.7rem}.ib-text{flex:1}
    .ib-text strong{display:block;font-size:.95rem;font-weight:700}
    .ib-text span{font-size:.7rem;color:var(--muted);font-family:'JetBrains Mono',monospace}
    .ib-install{padding:8px 16px;background:linear-gradient(135deg,var(--accent),#00b300);border:none;border-radius:100px;color:#000;font-family:'Rajdhani',sans-serif;font-size:.85rem;font-weight:700;cursor:pointer}
    .ib-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:1rem}
    #dimmer{position:fixed;inset:0;z-index:450;background:rgba(0,0,0,.5);display:none;backdrop-filter:blur(2px)}
    #dimmer.show{display:block}
  </style>
</head>
<body>
<canvas id="bg-canvas"></canvas>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ONBOARDING (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è 1 —Ä–∞–∑) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="onboarding">
  <div class="ob-slide active">
    <div class="ob-emoji">‚ö°</div>
    <div class="ob-title">Weltkind VPN</div>
    <div class="ob-desc">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!<br><br>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞—à–µ–π <strong>VPN-–ø–æ–¥–ø–∏—Å–∫–æ–π</strong> ‚Äî –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ –ø—Ä—è–º–æ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞.</div>
  </div>
  <div class="ob-slide">
    <div class="ob-emoji">üì±</div>
    <div class="ob-title">–í–æ–π–¥–∏—Ç–µ –ø–æ –Ω–æ–º–µ—Ä—É</div>
    <div class="ob-desc">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ <strong>79161234567</strong><br><br>–°–∏—Å—Ç–µ–º–∞ –Ω–∞–π–¥—ë—Ç –≤–∞—à—É –ø–æ–¥–ø–∏—Å–∫—É –∏ –ø–æ–∫–∞–∂–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã.</div>
  </div>
  <div class="ob-slide">
    <div class="ob-emoji">üîî</div>
    <div class="ob-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
    <div class="ob-desc">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <strong>üîî</strong> –≤ –ø—Ä–∞–≤–æ–º —É–≥–ª—É –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ Telegram-–±–æ—Ç–∞.<br><br>–í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ <strong>–∑–∞ 3 –¥–Ω—è</strong> –¥–æ –∫–æ–Ω—Ü–∞ –ø–æ–¥–ø–∏—Å–∫–∏.</div>
  </div>
  <div class="ob-dots">
    <div class="ob-dot active"></div>
    <div class="ob-dot"></div>
    <div class="ob-dot"></div>
  </div>
  <button class="ob-btn" id="ob-next-btn" onclick="obNext()">–î–∞–ª–µ–µ ‚Üí</button>
  <button class="ob-skip" onclick="obFinish()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SPLASH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="splash">
  <div class="vpn-orb">
    <div class="orb-ring"></div><div class="orb-ring"></div><div class="orb-ring"></div>
    <div class="orb-core"></div>
  </div>
  <div class="splash-brand">WELTKIND</div>
  <div class="splash-sub">SECURE ¬∑ PRIVATE ¬∑ FAST</div>
  <div class="splash-bar"><div class="splash-bar-fill"></div></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header id="hdr">
  <div class="hdr-left">
    <div class="hdr-brand">‚ö° Weltkind</div>
    <div id="ip-chip" title="–í–∞—à IP">
      <span id="ip-flag">üåê</span>
      <span id="ip-text">...</span>
    </div>
  </div>
  <div class="hdr-right">
    <div class="conn-pill" onclick="togglePanel()">
      <div class="conn-dot blink" id="conn-dot"></div>
      <span id="conn-text">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
    </div>
    <div class="bell-btn" onclick="togglePanel()">üîî
      <div class="bell-badge" id="bell-badge"></div>
    </div>
  </div>
</header>

<div id="offline-bar">üì° –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ‚Äî –ø–æ–∫–∞–∑–∞–Ω—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>
<div id="dimmer" onclick="closePanel()"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="notif-panel">
  <div class="np-title">üìä –ú–æ—è –ø–æ–¥–ø–∏—Å–∫–∞</div>

  <!-- –î–∞—à–±–æ—Ä–¥ -->
  <div id="dash-card" class="dash-card">
    <div class="dc-head">
      <span class="dc-lbl">Weltkind VPN</span>
      <span class="dc-badge" id="dc-badge">‚Äî</span>
    </div>
    <div class="dc-days-num" id="dc-days">‚Äî</div>
    <div class="dc-days-sub" id="dc-days-sub">–¥–Ω–µ–π –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è</div>
    <div class="dc-meta">
      <div class="dc-meta-item">
        <div class="dc-meta-lbl">–ò—Å—Ç–µ–∫–∞–µ—Ç</div>
        <div class="dc-meta-val" id="dc-expiry">‚Äî</div>
      </div>
      <div class="dc-meta-item">
        <div class="dc-meta-lbl">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</div>
        <div class="dc-meta-val" id="dc-synced">‚Äî</div>
      </div>
    </div>
    <div class="sub-bar"><div class="sub-bar-fill" id="sub-fill" style="width:0%"></div></div>
  </div>

  <div id="np-hint" class="np-hint">‚¨áÔ∏è –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>

  <!-- –ò—Å—Ç–æ—Ä–∏—è -->
  <div id="history-section" style="display:none">
    <div class="np-label">üìã –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥–ª–µ–Ω–∏–π</div>
    <div class="history-list" id="history-list"></div>
    <div style="height:8px"></div>
  </div>

  <div class="np-divider"></div>

  <button class="np-btn np-btn-blue" onclick="shareApp()">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º</button>
  <button class="np-btn np-btn-purple" id="cal-btn" onclick="addToCalendar()" style="display:none">üìÖ –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å</button>
  <button class="np-btn np-btn-red" id="notif-off-btn" onclick="disableNotif()" style="display:none">üîï –û—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>

  <div class="np-divider"></div>

  <div class="np-section">
    <div class="np-label">–í–≤–µ—Å—Ç–∏ –¥–∞—Ç—É –≤—Ä—É—á–Ω—É—é</div>
    <input type="date" id="np-date" class="np-input"/>
  </div>
  <button class="np-btn np-btn-green" onclick="saveNotif()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞—Ç—É</button>
  <button class="np-btn np-btn-blue" onclick="testNotif()">üß™ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
  <div id="np-status" class="np-status"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FRAME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="frame-wrap">
  <div id="pull-indicator">üîÑ</div>
  <div id="offline-page">
    <div class="offline-icon">üì°</div>
    <div class="offline-title">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
    <div class="offline-sub">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.<br>–î–∞–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∏–∑ –∫—ç—à–∞ ‚Äî –Ω–∏–∂–µ.</div>
    <div class="offline-card" id="ol-card" style="display:none">
      <div class="offline-card-title">–ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>
      <div class="offline-row"><span>–°—Ç–∞—Ç—É—Å</span><span class="offline-val" id="ol-status">‚Äî</span></div>
      <div class="offline-row"><span>–ò—Å—Ç–µ–∫–∞–µ—Ç</span><span class="offline-val" id="ol-expiry">‚Äî</span></div>
      <div class="offline-row"><span>–û—Å—Ç–∞–ª–æ—Å—å</span><span class="offline-val" id="ol-days">‚Äî</span></div>
    </div>
    <button class="offline-retry" onclick="retryConn()">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
  </div>
  <iframe id="main-frame"
    src="https://script.google.com/macros/s/AKfycbxfUBsBIMK6qULmIlqfxoOR9bWtjmc4uofYt3jWjGMd0Ql8kL4u32a7I9cgl22N3pJt8g/exec"
    title="Weltkind"
    sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-top-navigation allow-modals">
  </iframe>
</div>

<div id="install-banner">
  <div class="ib-icon">üì≤</div>
  <div class="ib-text"><strong>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</strong><span>–†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –Ω–∞—Ç–∏–≤–Ω–æ–µ</span></div>
  <button class="ib-install" id="install-btn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
  <button class="ib-close" onclick="document.getElementById('install-banner').classList.remove('show')">‚úï</button>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê MATRIX BG ‚ïê‚ïê‚ïê‚ïê */
(function(){
  const c=document.getElementById('bg-canvas'),ctx=c.getContext('2d');
  let cols,drops;const chars='01„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±';
  function resize(){c.width=innerWidth;c.height=innerHeight;cols=Math.floor(c.width/18);drops=Array(cols).fill(1);}
  function draw(){ctx.fillStyle='rgba(5,13,20,.06)';ctx.fillRect(0,0,c.width,c.height);ctx.fillStyle='#00e676';ctx.font='13px monospace';for(let i=0;i<drops.length;i++){ctx.fillText(chars[Math.floor(Math.random()*chars.length)],i*18,drops[i]*18);if(drops[i]*18>c.height&&Math.random()>.975)drops[i]=0;drops[i]++;}}
  resize();window.addEventListener('resize',resize);setInterval(draw,55);
})();

/* ‚ïê‚ïê‚ïê‚ïê ONBOARDING ‚ïê‚ïê‚ïê‚ïê */
let obIdx=0;
function obInit(){if(localStorage.getItem('onboarded'))document.getElementById('onboarding').classList.add('done');}
function obNext(){
  obIdx++;
  if(obIdx>=3){obFinish();return;}
  document.querySelectorAll('.ob-slide').forEach((s,i)=>s.classList.toggle('active',i===obIdx));
  document.querySelectorAll('.ob-dot').forEach((d,i)=>d.classList.toggle('active',i===obIdx));
  if(obIdx===2)document.getElementById('ob-next-btn').textContent='–ù–∞—á–∞—Ç—å ‚Üí';
}
function obFinish(){localStorage.setItem('onboarded','1');document.getElementById('onboarding').classList.add('done');}

/* ‚ïê‚ïê‚ïê‚ïê IP WIDGET ‚ïê‚ïê‚ïê‚ïê */
function flagEmoji(code){
  if(!code||code.length!==2)return'üåê';
  return String.fromCodePoint(...[...code.toUpperCase()].map(c=>0x1F1E6+c.charCodeAt(0)-65));
}
async function loadIP(){
  const cached=sessionStorage.getItem('ip_data');
  if(cached){applyIP(JSON.parse(cached));return;}
  try{
    const r=await fetch('https://ipapi.co/json/',{signal:AbortSignal.timeout(5000)});
    const d=await r.json();
    if(d.ip){
      const data={ip:d.ip,country:d.country_code||'',city:d.city||''};
      sessionStorage.setItem('ip_data',JSON.stringify(data));
      applyIP(data);
    }
  }catch(e){document.getElementById('ip-text').textContent='VPN';}
}
function applyIP(d){
  const parts=(d.ip||'').split('.');
  const short=parts.length===4?`${parts[0]}.*.*.${parts[3]}`:d.ip;
  document.getElementById('ip-flag').textContent=flagEmoji(d.country);
  document.getElementById('ip-text').textContent=`${d.country} ${short}`.trim();
  document.getElementById('ip-chip').classList.add('loaded');
  document.getElementById('ip-chip').title=`IP: ${d.ip}${d.city?' ¬∑ '+d.city:''}`;
}

/* ‚ïê‚ïê‚ïê‚ïê IFRAME ‚ïê‚ïê‚ïê‚ïê */
const frame=document.getElementById('main-frame');
const dot=document.getElementById('conn-dot');
const txt=document.getElementById('conn-text');
let splashT=setTimeout(()=>{document.getElementById('splash').classList.add('out');txt.textContent='–º–µ–¥–ª–µ–Ω–Ω–æ';},9000);
frame.addEventListener('load',()=>{
  clearTimeout(splashT);
  frame.classList.add('loaded');
  setTimeout(()=>document.getElementById('splash').classList.add('out'),400);
  applyStoredSub(loadSub());checkExpiry();
});

/* ‚ïê‚ïê‚ïê‚ïê SERVICE WORKER ‚ïê‚ïê‚ïê‚ïê */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(reg=>{
    if('periodicSync' in reg)reg.periodicSync.register('check-subscription',{minInterval:86400000}).catch(()=>{});
  }).catch(()=>{});
  navigator.serviceWorker.addEventListener('message',e=>{if(e.data?.type==='bg_check')checkExpiry();});
}

/* ‚ïê‚ïê‚ïê‚ïê NETWORK ‚ïê‚ïê‚ïê‚ïê */
function updateNet(){
  const online=navigator.onLine;
  document.getElementById('offline-bar').classList.toggle('show',!online);
  document.getElementById('offline-page').classList.toggle('show',!online);
  frame.style.display=online?'block':'none';
  if(!online){
    const sub=loadSub();
    if(sub.date){
      document.getElementById('ol-card').style.display='block';
      document.getElementById('ol-status').textContent=sub.status||'‚Äî';
      document.getElementById('ol-expiry').textContent=new Date(sub.date).toLocaleDateString('ru-RU');
      const d=daysLeft(sub.date);
      const el=document.getElementById('ol-days');
      el.textContent=d===null?'‚Äî':d<=0?'–∏—Å—Ç–µ–∫–ª–∞':d+' –¥–Ω.';
      el.className='offline-val'+(d!==null&&d<=0?' err':d!==null&&d<=3?' warn':'');
    }
  }
}
function retryConn(){if(navigator.onLine){updateNet();frame.src=frame.src;}}
window.addEventListener('online',updateNet);
window.addEventListener('offline',updateNet);

/* ‚ïê‚ïê‚ïê‚ïê PULL-TO-REFRESH ‚ïê‚ïê‚ïê‚ïê */
let ptY=0,ptDiff=0,ptOn=false;
const PTR=65,pin=document.getElementById('pull-indicator');
const fw=document.getElementById('frame-wrap');
fw.addEventListener('touchstart',e=>{ptY=e.touches[0].clientY;ptOn=true;},{passive:true});
fw.addEventListener('touchmove',e=>{
  if(!ptOn||!navigator.onLine)return;
  ptDiff=e.touches[0].clientY-ptY;
  if(ptDiff>0&&ptDiff<PTR*1.8){
    const p=Math.min(ptDiff/PTR,1);
    pin.style.display='flex';
    pin.style.opacity=p.toString();
    pin.style.transform=`translateX(-50%) translateY(${-60+68*p}px) rotate(${p*180}deg)`;
  }
},{passive:true});
fw.addEventListener('touchend',()=>{
  if(!ptOn)return;ptOn=false;
  if(ptDiff>=PTR&&navigator.onLine){
    pin.classList.add('spinning');
    frame.src=frame.src;
    frame.addEventListener('load',()=>{pin.classList.remove('spinning');pin.style.opacity='0';setTimeout(()=>pin.style.display='none',400);},{once:true});
  }else{pin.style.opacity='0';setTimeout(()=>pin.style.display='none',300);}
  ptDiff=0;pin.style.transform='translateX(-50%) translateY(-60px)';
});

/* ‚ïê‚ïê‚ïê‚ïê STORAGE ‚ïê‚ïê‚ïê‚ïê */
function loadSub(){try{return JSON.parse(localStorage.getItem('vpn_s')||'{}')||{};}catch(e){return{};}}
function saveSub(o){localStorage.setItem('vpn_s',JSON.stringify(o));}
function loadHist(){try{return JSON.parse(localStorage.getItem('vpn_hist')||'[]');}catch(e){return[];}}
function saveHist(a){localStorage.setItem('vpn_hist',JSON.stringify(a));}

/* ‚ïê‚ïê‚ïê‚ïê DATE HELPERS ‚ïê‚ïê‚ïê‚ïê */
function toISO(str){
  if(!str||str==='–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'||str==='–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ')return null;
  const p=str.split('.');if(p.length===3)return`${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
  const d=new Date(str);return isNaN(d)?null:d.toISOString().slice(0,10);
}
function daysLeft(iso){if(!iso)return null;return Math.ceil((new Date(iso)-Date.now())/86400000);}

/* ‚ïê‚ïê‚ïê‚ïê BADGE ‚ïê‚ïê‚ïê‚ïê */
function updateBadge(days){
  if(!('setAppBadge' in navigator))return;
  if(days===null){navigator.clearAppBadge().catch(()=>{});return;}
  days<=0?navigator.setAppBadge(99).catch(()=>{}):days<=30?navigator.setAppBadge(days).catch(()=>{}):navigator.clearAppBadge().catch(()=>{});
}

/* ‚ïê‚ïê‚ïê‚ïê postMessage FROM IFRAME ‚ïê‚ïê‚ïê‚ïê */
window.addEventListener('message',e=>{
  if(!e.data||e.data.type!=='weltkind_sub')return;
  console.log('[PWA] postMessage:',e.data);
  handleSubData(e.data.expiryDate,e.data.status,e.data.phone);
});

/* ‚ïê‚ïê‚ïê‚ïê HANDLE SUB DATA ‚ïê‚ïê‚ïê‚ïê */
function handleSubData(expiryDate,status,phone){
  const iso=toISO(expiryDate);
  const prev=loadSub();
  let total=prev.totalDays||30;
  if(iso){const d=daysLeft(iso);if(d&&d>total)total=d;}
  const sub={date:iso,displayDate:expiryDate,status,phone,totalDays:total,syncedAt:Date.now()};
  saveSub(sub);
  // –ò—Å—Ç–æ—Ä–∏—è: –¥–æ–±–∞–≤–ª—è–µ–º –µ—Å–ª–∏ –¥–∞—Ç–∞ –Ω–æ–≤–∞—è –∏ –æ–ø–ª–∞—á–µ–Ω–æ
  if(iso&&iso!==prev.date&&status==='–û–ø–ª–∞—á–µ–Ω–æ'){
    const hist=loadHist();
    if(!hist.find(h=>h.date===iso)){hist.unshift({date:iso,savedAt:Date.now()});if(hist.length>10)hist.length=10;saveHist(hist);}
  }
  applyStoredSub(sub);checkExpiry();
  if(iso&&status==='–û–ø–ª–∞—á–µ–Ω–æ')autoAskPerm();
  if(document.getElementById('notif-panel').classList.contains('open'))renderDash();
}

/* ‚ïê‚ïê‚ïê‚ïê HEADER STATUS ‚ïê‚ïê‚ïê‚ïê */
function applyStoredSub(sub){
  if(!sub||!sub.date){dot.className='conn-dot blink';dot.style.background='var(--warn)';dot.style.boxShadow='';txt.textContent='–≤–æ–π–¥–∏—Ç–µ';updateBadge(null);return;}
  const d=daysLeft(sub.date);dot.classList.remove('blink');updateBadge(d);
  if(d===null){txt.textContent='‚Äî';dot.style.background='var(--muted)';}
  else if(d<=0){dot.style.background='#ff1744';dot.style.boxShadow='0 0 8px #ff1744';dot.classList.add('blink');txt.textContent='–∏—Å—Ç–µ–∫–ª–∞!';document.getElementById('bell-badge').classList.add('show');}
  else if(d<=3){dot.style.background='var(--warn)';dot.style.boxShadow='0 0 8px var(--warn)';dot.classList.add('blink');txt.textContent=d+' –¥–Ω.';document.getElementById('bell-badge').classList.add('show');}
  else{dot.style.background='var(--accent)';dot.style.boxShadow='0 0 8px var(--accent)';txt.textContent=d+' –¥–Ω.';}
}

/* ‚ïê‚ïê‚ïê‚ïê RENDER DASHBOARD ‚ïê‚ïê‚ïê‚ïê */
function renderDash(){
  const sub=loadSub();
  const card=document.getElementById('dash-card');
  const fill=document.getElementById('sub-fill');
  const hint=document.getElementById('np-hint');
  const histSec=document.getElementById('history-section');
  const calBtn=document.getElementById('cal-btn');
  const offBtn=document.getElementById('notif-off-btn');

  if(!sub||!sub.date){
    card.className='dash-card';
    document.getElementById('dc-badge').textContent='‚Äî';
    document.getElementById('dc-days').textContent='‚Äî';
    document.getElementById('dc-days-sub').textContent='–¥–Ω–µ–π –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è';
    document.getElementById('dc-expiry').textContent='‚Äî';
    document.getElementById('dc-synced').textContent='‚Äî';
    fill.style.width='0%';hint.style.display='block';
    offBtn.style.display='none';calBtn.style.display='none';histSec.style.display='none';
    return;
  }
  hint.style.display='none';offBtn.style.display='block';calBtn.style.display='block';
  document.getElementById('dc-expiry').textContent=new Date(sub.date).toLocaleDateString('ru-RU');
  document.getElementById('dc-synced').textContent=sub.syncedAt?new Date(sub.syncedAt).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}):'‚Äî';

  const d=daysLeft(sub.date);
  if(d===null){card.className='dash-card';}
  else if(d<=0){
    card.className='dash-card err';
    document.getElementById('dc-badge').textContent='‚ùå –ò—Å—Ç–µ–∫–ª–∞';
    document.getElementById('dc-days').textContent=Math.abs(d);
    document.getElementById('dc-days-sub').textContent='–¥–Ω–µ–π –Ω–∞–∑–∞–¥';
    fill.style.width='100%';fill.style.background='#ff1744';
  }else if(d<=3){
    card.className='dash-card warn';
    document.getElementById('dc-badge').textContent='‚ö†Ô∏è –°–∫–æ—Ä–æ';
    document.getElementById('dc-days').textContent=d;
    document.getElementById('dc-days-sub').textContent='–¥–Ω—è –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è';
    fill.style.width=Math.round((3-d)/3*100)+'%';fill.style.background='var(--warn)';
  }else{
    card.className='dash-card ok';
    document.getElementById('dc-badge').textContent='‚úÖ –ê–∫—Ç–∏–≤–Ω–∞';
    document.getElementById('dc-days').textContent=d;
    document.getElementById('dc-days-sub').textContent='–¥–Ω–µ–π –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è';
    const pct=Math.max(5,Math.min(100,Math.round(d/(sub.totalDays||30)*100)));
    fill.style.width=pct+'%';fill.style.background='var(--accent)';
  }

  const hist=loadHist();
  if(hist.length>0){
    histSec.style.display='block';
    document.getElementById('history-list').innerHTML=hist.slice(0,4).map(h=>`
      <div class="history-item">
        <span class="history-date">${new Date(h.savedAt).toLocaleDateString('ru-RU')}</span>
        <span class="history-val">–¥–æ ${new Date(h.date).toLocaleDateString('ru-RU')}</span>
      </div>`).join('');
  }else{histSec.style.display='none';}
  if(Notification.permission==='granted')document.getElementById('bell-badge').classList.add('show');
}

/* ‚ïê‚ïê‚ïê‚ïê PANEL ‚ïê‚ïê‚ïê‚ïê */
function togglePanel(){
  const p=document.getElementById('notif-panel'),d=document.getElementById('dimmer');
  if(p.classList.contains('open')){closePanel();}
  else{p.classList.add('open');d.classList.add('show');renderDash();const s=loadSub();if(s.date)document.getElementById('np-date').value=s.date;}
}
function closePanel(){document.getElementById('notif-panel').classList.remove('open');document.getElementById('dimmer').classList.remove('show');}

/* ‚ïê‚ïê‚ïê‚ïê SHARE ‚ïê‚ïê‚ïê‚ïê */
async function shareApp(){
  const data={title:'Weltkind VPN',text:'üîê –ë—ã—Å—Ç—Ä—ã–π –∏ –Ω–∞–¥—ë–∂–Ω—ã–π VPN ‚Äî —É–ø—Ä–∞–≤–ª—è–π –ø–æ–¥–ø–∏—Å–∫–æ–π –ø—Ä—è–º–æ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞!',url:'https://weltkind666.github.io/777Weltkind777/'};
  try{
    if(navigator.share&&navigator.canShare&&navigator.canShare(data)){await navigator.share(data);}
    else{await navigator.clipboard.writeText(data.url);showSt('üîó –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!','ok');}
  }catch(e){if(e.name!=='AbortError'){navigator.clipboard.writeText(data.url).catch(()=>{});showSt('üîó –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!','ok');}}
}

/* ‚ïê‚ïê‚ïê‚ïê CALENDAR ‚ïê‚ïê‚ïê‚ïê */
function addToCalendar(){
  const sub=loadSub();if(!sub.date){showSt('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç','warn');return;}
  const exp=new Date(sub.date);
  const rem=new Date(exp);rem.setDate(rem.getDate()-3);
  const fmt=d=>d.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
  const ics=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Weltkind VPN//RU','BEGIN:VEVENT',
    `DTSTART:${fmt(rem)}`,`DTEND:${fmt(new Date(rem.getTime()+3600000))}`,
    'SUMMARY:‚ö†Ô∏è –ü–æ–¥–ø–∏—Å–∫–∞ Weltkind VPN –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 3 –¥–Ω—è',
    `DESCRIPTION:–ò—Å—Ç–µ–∫–∞–µ—Ç ${exp.toLocaleDateString('ru-RU')}. –ü—Ä–æ–¥–ª–∏—Ç—å: https://weltkind666.github.io/777Weltkind777/`,
    'BEGIN:VALARM','TRIGGER:-PT0M','ACTION:DISPLAY','DESCRIPTION:–ü—Ä–æ–¥–ª–∏—Ç–µ VPN!','END:VALARM',
    'END:VEVENT','END:VCALENDAR'].join('\r\n');
  const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([ics],{type:'text/calendar'})),download:'weltkind.ics'});
  a.click();URL.revokeObjectURL(a.href);
  showSt('üìÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å','ok');
}

/* ‚ïê‚ïê‚ïê‚ïê NOTIFICATIONS ‚ïê‚ïê‚ïê‚ïê */
async function autoAskPerm(){
  if(Notification.permission==='default'){const p=await Notification.requestPermission();if(p==='granted'){showSt('‚úÖ –£–≤–µ–¥–æ–º–ª—é –∑–∞ 3 –¥–Ω—è –¥–æ –∫–æ–Ω—Ü–∞ –ø–æ–¥–ø–∏—Å–∫–∏!','ok');document.getElementById('bell-badge').classList.add('show');}}
}
async function saveNotif(){
  const date=document.getElementById('np-date').value;if(!date){showSt('‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É','warn');return;}
  let p=Notification.permission;if(p==='default')p=await Notification.requestPermission();
  if(p==='denied'){showSt('‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –±—Ä–∞—É–∑–µ—Ä–æ–º','err');return;}
  const sub=loadSub();sub.date=date;sub.totalDays=sub.totalDays||30;sub.savedAt=Date.now();
  saveSub(sub);applyStoredSub(sub);renderDash();
  showSt('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!','ok');document.getElementById('bell-badge').classList.add('show');checkExpiry();
}
function disableNotif(){saveSub({});applyStoredSub({});renderDash();document.getElementById('bell-badge').classList.remove('show');document.getElementById('np-date').value='';updateBadge(null);showSt('üîï –û—Ç–∫–ª—é—á–µ–Ω–æ','warn');}
async function testNotif(){
  let p=Notification.permission;if(p==='default')p=await Notification.requestPermission();
  if(p==='denied'){showSt('‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ','err');return;}
  setTimeout(()=>{const n=new Notification('‚úÖ Weltkind ‚Äî —Ç–µ—Å—Ç',{body:'–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç!',icon:'icons/icon-192.png',tag:'vpn-test'});n.onclick=()=>{window.focus();n.close();};},500);
  showSt('üì¨ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!','ok');
}
function checkExpiry(){
  const sub=loadSub();if(!sub.date||Notification.permission!=='granted')return;
  const d=daysLeft(sub.date);if(d===null||d>3)return;
  const title=d<=0?'üö® –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞!':`‚ö†Ô∏è –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ ${d} –¥–Ω.`;
  const body=d<=0?'–ü—Ä–æ–¥–ª–∏—Ç–µ VPN –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!':'–ó–∞–π–¥–∏—Ç–µ –∏ –ø—Ä–æ–¥–ª–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É.';
  setTimeout(()=>{const n=new Notification(title,{body,icon:'icons/icon-192.png',tag:'vpn-expiry',renotify:true,vibrate:[200,100,200]});n.onclick=()=>{window.focus();n.close();};},1500);
  document.getElementById('bell-badge').classList.add('show');
}
function showSt(msg,type){const e=document.getElementById('np-status');e.textContent=msg;e.className='np-status show '+type;}

/* ‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê */
document.addEventListener('DOMContentLoaded',()=>{
  obInit();loadIP();updateNet();
  const sub=loadSub();if(sub.date){applyStoredSub(sub);checkExpiry();}
  setInterval(checkExpiry,3600000);
  (function sched(){const now=new Date(),next=new Date(now);next.setHours(9,0,0,0);if(next<=now)next.setDate(next.getDate()+1);setTimeout(()=>{checkExpiry();sched();},next-now);})();
});

/* ‚ïê‚ïê‚ïê‚ïê PWA INSTALL ‚ïê‚ïê‚ïê‚ïê */
let dp=null;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();dp=e;setTimeout(()=>document.getElementById('install-banner').classList.add('show'),4000);});
document.getElementById('install-btn').onclick=async()=>{document.getElementById('install-banner').classList.remove('show');if(dp){dp.prompt();await dp.userChoice;dp=null;}};
window.addEventListener('appinstalled',()=>document.getElementById('install-banner').classList.remove('show'));
</script>
</body>
</html>
