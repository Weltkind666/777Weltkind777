<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta name="theme-color" content="#050d14"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="Weltkind"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="apple-touch-icon" href="icons/icon-192.png"/>
  <link rel="icon" href="icons/icon-192.png"/>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet"/>
  <title>Weltkind</title>
  <style>
    :root{--bg:#050d14;--surface:#0a1929;--card:#0d2137;--accent:#00e676;--accent2:#00b0ff;--warn:#ff6d00;--text:#e0f7fa;--muted:#546e7a;--border:rgba(0,230,118,.12);}
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;overflow:hidden;background:var(--bg);font-family:'Rajdhani',sans-serif;color:var(--text)}
    #bg-canvas{position:fixed;inset:0;z-index:0;opacity:.3}
    #splash{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .6s ease}
    #splash.out{opacity:0;pointer-events:none}
    .vpn-orb{position:relative;width:140px;height:140px;margin-bottom:28px}
    .orb-core{position:absolute;inset:30px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#00e676,#005f2d);box-shadow:0 0 40px rgba(0,230,118,.8);animation:op 2.5s ease-in-out infinite}
    .orb-ring{position:absolute;inset:0;border-radius:50%;border:2px solid rgba(0,230,118,.5);animation:re 2.5s ease-out infinite}
    .orb-ring:nth-child(2){animation-delay:.8s}
    .orb-ring:nth-child(3){animation-delay:1.6s}
    @keyframes op{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
    @keyframes re{0%{transform:scale(.6);opacity:.8}100%{transform:scale(1.7);opacity:0}}
    .splash-brand{font-size:2.2rem;font-weight:700;letter-spacing:.08em;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .splash-sub{margin-top:8px;font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--muted);letter-spacing:.15em}
    .splash-bar{margin-top:32px;width:160px;height:2px;background:rgba(0,230,118,.12);border-radius:2px;overflow:hidden}
    .splash-bar-fill{height:100%;width:0%;background:var(--accent);border-radius:2px;animation:bf 2.2s ease forwards}
    @keyframes bf{to{width:100%}}
    #hdr{position:fixed;top:0;left:0;right:0;height:52px;z-index:200;background:rgba(5,13,20,.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 16px}
    .hdr-brand{font-size:1.1rem;font-weight:700;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .hdr-right{display:flex;align-items:center;gap:10px}
    .conn-pill{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;background:rgba(0,230,118,.08);border:1px solid rgba(0,230,118,.2);font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--accent);cursor:pointer;transition:background .2s}
    .conn-pill:hover{background:rgba(0,230,118,.15)}
    .conn-dot{width:6px;height:6px;border-radius:50%;background:var(--warn);transition:background .4s,box-shadow .4s}
    .conn-dot.blink{animation:blink 2s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
    .bell-btn{position:relative;width:36px;height:36px;border-radius:10px;background:rgba(0,176,255,.08);border:1px solid rgba(0,176,255,.2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.1rem;transition:background .2s}
    .bell-btn:hover{background:rgba(0,176,255,.2)}
    .bell-badge{position:absolute;top:4px;right:4px;width:8px;height:8px;background:var(--warn);border-radius:50%;border:1px solid var(--bg);display:none}
    .bell-badge.show{display:block}
    #frame-wrap{position:fixed;top:52px;left:0;right:0;bottom:0;z-index:10}
    #main-frame{width:100%;height:100%;border:none;display:block;opacity:0;transition:opacity .5s}
    #main-frame.loaded{opacity:1}

    /* ‚îÄ‚îÄ‚îÄ Notification Panel ‚îÄ‚îÄ‚îÄ */
    #notif-panel{position:fixed;top:60px;right:12px;z-index:500;width:min(320px,92vw);background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 16px 48px rgba(0,0,0,.7);transform:translateY(-20px) scale(.95);opacity:0;pointer-events:none;transition:all .3s cubic-bezier(.34,1.56,.64,1)}
    #notif-panel.open{transform:translateY(0) scale(1);opacity:1;pointer-events:all}
    .np-title{font-size:1rem;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
    .np-label{font-family:'JetBrains Mono',monospace;font-size:.63rem;color:var(--muted);letter-spacing:.1em;margin-bottom:6px;text-transform:uppercase}
    .np-section{margin-bottom:12px}
    .np-input{width:100%;padding:9px 12px;border-radius:9px;background:rgba(0,230,118,.05);border:1px solid var(--border);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.8rem;outline:none;transition:border .2s}
    .np-input:focus{border-color:var(--accent)}
    .np-btn{width:100%;padding:10px;border-radius:10px;border:none;font-family:'Rajdhani',sans-serif;font-size:.95rem;font-weight:700;cursor:pointer;transition:all .2s;margin-bottom:8px}
    .np-btn-green{background:linear-gradient(135deg,var(--accent),#00b300);color:#000}
    .np-btn-green:hover{box-shadow:0 0 20px rgba(0,230,118,.4);transform:translateY(-1px)}
    .np-btn-blue{background:rgba(0,176,255,.1);border:1px solid rgba(0,176,255,.25);color:var(--accent2)}
    .np-btn-red{background:rgba(255,23,68,.08);border:1px solid rgba(255,23,68,.25);color:#ff6b6b}

    /* Auto-sync status card */
    .sync-card{border-radius:12px;padding:12px 14px;margin-bottom:12px;border:1px solid var(--border);background:rgba(0,230,118,.04)}
    .sync-card.ok{border-color:rgba(0,230,118,.35);background:rgba(0,230,118,.07)}
    .sync-card.warn{border-color:rgba(255,109,0,.35);background:rgba(255,109,0,.07)}
    .sync-card.err{border-color:rgba(255,23,68,.35);background:rgba(255,23,68,.07)}
    .sync-card .sc-row{display:flex;justify-content:space-between;align-items:center;font-size:.82rem;margin-bottom:4px}
    .sync-card .sc-row:last-child{margin-bottom:0}
    .sync-card .sc-label{color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:.7rem}
    .sync-card .sc-val{font-weight:700}
    .sync-card.ok .sc-val{color:var(--accent)}
    .sync-card.warn .sc-val{color:var(--warn)}
    .sync-card.err .sc-val{color:#ff6b6b}
    .sync-hint{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--muted);text-align:center;margin-top:8px;line-height:1.5}
    .np-divider{height:1px;background:var(--border);margin:12px 0}
    .np-status{font-family:'JetBrains Mono',monospace;font-size:.72rem;margin-top:10px;padding:8px 10px;border-radius:8px;background:rgba(0,230,118,.05);border:1px solid var(--border);display:none}
    .np-status.show{display:block}
    .np-status.ok{color:var(--accent);border-color:rgba(0,230,118,.3)}
    .np-status.warn{color:var(--warn);border-color:rgba(255,109,0,.3)}
    .np-status.err{color:#ff1744;border-color:rgba(255,23,68,.3)}

    /* Subscription progress bar */
    .sub-progress{margin:10px 0 4px}
    .sub-progress-bar{height:4px;border-radius:2px;background:rgba(255,255,255,.08);overflow:hidden;margin-top:6px}
    .sub-progress-fill{height:100%;border-radius:2px;transition:width .6s ease,background .4s}

    #install-banner{display:none;position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:var(--card);border:1px solid rgba(0,230,118,.25);border-radius:14px;padding:12px 16px;flex-direction:row;align-items:center;gap:12px;z-index:400;box-shadow:0 8px 32px rgba(0,0,0,.6);min-width:260px;max-width:90vw;animation:su .4s cubic-bezier(.34,1.56,.64,1)}
    @keyframes su{from{transform:translateX(-50%) translateY(80px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
    #install-banner.show{display:flex}
    .ib-icon{font-size:1.7rem}
    .ib-text{flex:1}
    .ib-text strong{display:block;font-size:.95rem;font-weight:700}
    .ib-text span{font-size:.7rem;color:var(--muted);font-family:'JetBrains Mono',monospace}
    .ib-install{padding:8px 16px;background:linear-gradient(135deg,var(--accent),#00b300);border:none;border-radius:100px;color:#000;font-family:'Rajdhani',sans-serif;font-size:.85rem;font-weight:700;cursor:pointer}
    .ib-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:1rem}
    #dimmer{position:fixed;inset:0;z-index:450;background:rgba(0,0,0,.5);display:none;backdrop-filter:blur(2px)}
    #dimmer.show{display:block}
  </style>
</head>
<body>
<canvas id="bg-canvas"></canvas>

<div id="splash">
  <div class="vpn-orb">
    <div class="orb-ring"></div><div class="orb-ring"></div><div class="orb-ring"></div>
    <div class="orb-core"></div>
  </div>
  <div class="splash-brand">WELTKIND</div>
  <div class="splash-sub">SECURE ¬∑ PRIVATE ¬∑ FAST</div>
  <div class="splash-bar"><div class="splash-bar-fill"></div></div>
</div>

<header id="hdr">
  <div class="hdr-brand">‚ö° Weltkind</div>
  <div class="hdr-right">
    <div class="conn-pill" onclick="togglePanel()" title="–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏">
      <div class="conn-dot blink" id="conn-dot"></div>
      <span id="conn-text">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
    </div>
    <div class="bell-btn" id="bell-btn" onclick="togglePanel()">üîî
      <div class="bell-badge" id="bell-badge"></div>
    </div>
  </div>
</header>

<div id="dimmer" onclick="closePanel()"></div>

<!-- ‚îÄ‚îÄ‚îÄ Notification Panel ‚îÄ‚îÄ‚îÄ -->
<div id="notif-panel">
  <div class="np-title">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–µ</div>

  <!-- –°—Ç–∞—Ç—É—Å (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ iframe) -->
  <div id="sync-card" class="sync-card">
    <div class="sc-row">
      <span class="sc-label">–°–¢–ê–¢–£–°</span>
      <span class="sc-val" id="sc-status">‚Äî</span>
    </div>
    <div class="sc-row">
      <span class="sc-label">–ò–°–¢–ï–ö–ê–ï–¢</span>
      <span class="sc-val" id="sc-expiry">‚Äî</span>
    </div>
    <div class="sc-row">
      <span class="sc-label">–û–°–¢–ê–õ–û–°–¨</span>
      <span class="sc-val" id="sc-days">‚Äî</span>
    </div>
    <div class="sub-progress">
      <div class="sub-progress-bar"><div class="sub-progress-fill" id="sub-fill" style="width:0%"></div></div>
    </div>
  </div>

  <div class="sync-hint" id="sync-hint">
    ‚¨áÔ∏è –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç –Ω–∏–∂–µ ‚Äî —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  </div>

  <div class="np-divider"></div>

  <!-- –†—É—á–Ω–æ–π –≤–≤–æ–¥ –¥–∞—Ç—ã (fallback) -->
  <div class="np-section">
    <div class="np-label">–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤—Ä—É—á–Ω—É—é</div>
    <input type="date" id="np-date" class="np-input"/>
  </div>

  <button class="np-btn np-btn-green" onclick="saveNotif()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤–∫–ª—é—á–∏—Ç—å</button>
  <button class="np-btn np-btn-blue" onclick="testNotif()">üß™ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
  <button class="np-btn np-btn-red" id="notif-off-btn" onclick="disableNotif()" style="display:none">üîï –û—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>

  <div id="np-status" class="np-status"></div>
</div>

<div id="frame-wrap">
  <iframe id="main-frame"
    src="https://script.google.com/macros/s/AKfycbxfUBsBIMK6qULmIlqfxoOR9bWtjmc4uofYt3jWjGMd0Ql8kL4u32a7I9cgl22N3pJt8g/exec"
    title="Weltkind"
    sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-top-navigation allow-modals">
  </iframe>
</div>

<div id="install-banner">
  <div class="ib-icon">üì≤</div>
  <div class="ib-text"><strong>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</strong><span>–†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –Ω–∞—Ç–∏–≤–Ω–æ–µ</span></div>
  <button class="ib-install" id="install-btn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
  <button class="ib-close" onclick="document.getElementById('install-banner').classList.remove('show')">‚úï</button>
</div>

<script>
/* ‚îÄ‚îÄ‚îÄ Matrix canvas ‚îÄ‚îÄ‚îÄ */
(function(){
  const c=document.getElementById('bg-canvas'),ctx=c.getContext('2d');
  let cols,drops;
  const chars='01„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±';
  function resize(){c.width=innerWidth;c.height=innerHeight;cols=Math.floor(c.width/18);drops=Array(cols).fill(1);}
  function draw(){ctx.fillStyle='rgba(5,13,20,.06)';ctx.fillRect(0,0,c.width,c.height);ctx.fillStyle='#00e676';ctx.font='13px monospace';for(let i=0;i<drops.length;i++){ctx.fillText(chars[Math.floor(Math.random()*chars.length)],i*18,drops[i]*18);if(drops[i]*18>c.height&&Math.random()>.975)drops[i]=0;drops[i]++;}};
  resize();window.addEventListener('resize',resize);setInterval(draw,55);
})();

/* ‚îÄ‚îÄ‚îÄ Iframe load ‚îÄ‚îÄ‚îÄ */
const frame=document.getElementById('main-frame');
const dot=document.getElementById('conn-dot');
const txt=document.getElementById('conn-text');
let splashTimer=setTimeout(()=>{
  document.getElementById('splash').classList.add('out');
  dot.classList.add('blink');
  dot.style.background='var(--warn)';
  txt.textContent='–º–µ–¥–ª–µ–Ω–Ω–æ';
},9000);

frame.addEventListener('load',()=>{
  clearTimeout(splashTimer);
  frame.classList.add('loaded');
  setTimeout(()=>document.getElementById('splash').classList.add('out'),400);
  // Header: –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ localStorage
  const stored=loadStoredSub();
  if(stored && stored.date){
    refreshHeaderStatus(stored);
  } else {
    dot.style.background='var(--accent)';
    dot.style.boxShadow='0 0 8px var(--accent)';
    dot.classList.remove('blink');
    txt.textContent='–≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç';
  }
  checkExpiry();
});

/* ‚îÄ‚îÄ‚îÄ Service Worker ‚îÄ‚îÄ‚îÄ */
if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});

/* ‚îÄ‚îÄ‚îÄ Panel open/close ‚îÄ‚îÄ‚îÄ */
function togglePanel(){
  const p=document.getElementById('notif-panel'),d=document.getElementById('dimmer');
  if(p.classList.contains('open')){closePanel();}
  else{
    p.classList.add('open');
    d.classList.add('show');
    renderSyncCard();
    const s=loadStoredSub();
    if(s && s.date) document.getElementById('np-date').value=s.date;
  }
}
function closePanel(){
  document.getElementById('notif-panel').classList.remove('open');
  document.getElementById('dimmer').classList.remove('show');
}

/* ‚îÄ‚îÄ‚îÄ localStorage helpers ‚îÄ‚îÄ‚îÄ */
function loadStoredSub(){
  try{ return JSON.parse(localStorage.getItem('vpn_s')||'{}'); }
  catch(e){ return {}; }
}
function saveStoredSub(obj){
  localStorage.setItem('vpn_s', JSON.stringify(obj));
}

/* ‚îÄ‚îÄ‚îÄ Convert "dd.mm.yyyy" ‚Üí "yyyy-mm-dd" ‚îÄ‚îÄ‚îÄ */
function displayDateToISO(str){
  if(!str || str==='–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ' || str==='–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ') return null;
  // "15.03.2025" ‚Üí "2025-03-15"
  const p=str.split('.');
  if(p.length===3) return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
  // Already ISO or other format
  const d=new Date(str);
  if(!isNaN(d)) return d.toISOString().slice(0,10);
  return null;
}

/* ‚îÄ‚îÄ‚îÄ Days left ‚îÄ‚îÄ‚îÄ */
function daysLeft(isoDate){
  if(!isoDate) return null;
  return Math.ceil((new Date(isoDate) - Date.now()) / 86400000);
}

/* ‚îÄ‚îÄ‚îÄ Sync card render ‚îÄ‚îÄ‚îÄ */
function renderSyncCard(){
  const s=loadStoredSub();
  const card=document.getElementById('sync-card');
  const scStatus=document.getElementById('sc-status');
  const scExpiry=document.getElementById('sc-expiry');
  const scDays=document.getElementById('sc-days');
  const fill=document.getElementById('sub-fill');
  const hint=document.getElementById('sync-hint');
  const offBtn=document.getElementById('notif-off-btn');

  if(!s || !s.date){
    card.className='sync-card';
    scStatus.textContent='–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
    scExpiry.textContent='‚Äî';
    scDays.textContent='‚Äî';
    fill.style.width='0%';
    fill.style.background='var(--muted)';
    hint.style.display='block';
    offBtn.style.display='none';
    return;
  }

  hint.style.display='none';
  offBtn.style.display='block';

  const days=daysLeft(s.date);
  scExpiry.textContent=new Date(s.date).toLocaleDateString('ru-RU');

  if(days===null){
    card.className='sync-card';
    scStatus.textContent='–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
    scDays.textContent='‚Äî';
  } else if(days<=0){
    card.className='sync-card err';
    scStatus.textContent='‚ùå –∏—Å—Ç–µ–∫–ª–∞';
    scDays.textContent=`${Math.abs(days)} –¥–Ω. –Ω–∞–∑–∞–¥`;
    fill.style.width='100%';
    fill.style.background='#ff1744';
  } else if(days<=3){
    card.className='sync-card warn';
    scStatus.textContent='‚ö†Ô∏è –∏—Å—Ç–µ–∫–∞–µ—Ç —Å–∫–æ—Ä–æ';
    scDays.textContent=`${days} –¥–Ω.`;
    const pct=Math.min(100, Math.round((3-days)/3*100));
    fill.style.width=pct+'%';
    fill.style.background='var(--warn)';
  } else {
    card.className='sync-card ok';
    scStatus.textContent='‚úÖ –∞–∫—Ç–∏–≤–Ω–∞';
    scDays.textContent=`${days} –¥–Ω.`;
    const totalDays=s.totalDays||30;
    const pct=Math.max(5, Math.min(100, Math.round(days/totalDays*100)));
    fill.style.width=pct+'%';
    fill.style.background='var(--accent)';
  }

  // Notification permission indicator
  if(Notification.permission==='granted'){
    document.getElementById('bell-badge').classList.add('show');
  }
}

/* ‚îÄ‚îÄ‚îÄ Refresh header (conn-pill) ‚îÄ‚îÄ‚îÄ */
function refreshHeaderStatus(s){
  if(!s || !s.date){
    dot.style.background='var(--warn)';
    dot.classList.add('blink');
    txt.textContent='–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
    return;
  }
  const days=daysLeft(s.date);
  dot.classList.remove('blink');
  if(days===null){
    dot.style.background='var(--muted)';
    txt.textContent='‚Äî';
  } else if(days<=0){
    dot.style.background='#ff1744';
    dot.style.boxShadow='0 0 8px #ff1744';
    txt.textContent='–∏—Å—Ç–µ–∫–ª–∞!';
    document.getElementById('bell-badge').classList.add('show');
  } else if(days<=3){
    dot.style.background='var(--warn)';
    dot.style.boxShadow='0 0 8px var(--warn)';
    dot.classList.add('blink');
    txt.textContent=`${days} –¥–Ω.`;
    document.getElementById('bell-badge').classList.add('show');
  } else {
    dot.style.background='var(--accent)';
    dot.style.boxShadow='0 0 8px var(--accent)';
    txt.textContent=`${days} –¥–Ω.`;
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ‚òÖ –ö–õ–Æ–ß–ï–í–ê–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø: —Å–ª—É—à–∞–µ–º postMessage
     –æ—Ç iframe (Apps Script)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.addEventListener('message', function(event){
  if(!event.data || event.data.type !== 'weltkind_sub') return;

  const {expiryDate, status, phone} = event.data;
  const isoDate = displayDateToISO(expiryDate);

  // –°—á–∏—Ç–∞–µ–º totalDays –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
  const prevStored = loadStoredSub();
  let totalDays = prevStored.totalDays || 30;
  if(isoDate){
    const d = daysLeft(isoDate);
    if(d !== null && d > totalDays) totalDays = d; // –º–∞–∫—Å–∏–º—É–º (–∫–æ–≥–¥–∞ —Ç–æ–ª—å–∫–æ –æ–ø–ª–∞—á–µ–Ω–æ)
  }

  const sub = {
    date: isoDate,
    displayDate: expiryDate,
    status: status,
    phone: phone,
    totalDays: totalDays,
    syncedAt: Date.now()
  };
  saveStoredSub(sub);

  // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–ø–∫—É
  refreshHeaderStatus(sub);

  // –ï—Å–ª–∏ –ø–∞–Ω–µ–ª—å –æ—Ç–∫—Ä—ã—Ç–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º
  if(document.getElementById('notif-panel').classList.contains('open')){
    renderSyncCard();
    if(isoDate) document.getElementById('np-date').value = isoDate;
  }

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
  if(isoDate && status === '–û–ø–ª–∞—á–µ–Ω–æ'){
    autoEnableNotifications(sub);
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º ‚Äî –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
  checkExpiry();
});

/* ‚îÄ‚îÄ‚îÄ Auto-enable notifications when subscription data arrives ‚îÄ‚îÄ‚îÄ */
async function autoEnableNotifications(sub){
  if(Notification.permission === 'default'){
    const perm = await Notification.requestPermission();
    if(perm !== 'granted') return;
  }
  if(Notification.permission === 'granted'){
    document.getElementById('bell-badge').classList.add('show');
    // –¢–∏—Ö–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É–∂–µ –≤–∫–ª—é—á–µ–Ω—ã
    showSt('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! –£–≤–µ–¥–æ–º–ª—é –∑–∞ 3 –¥–Ω—è –¥–æ –∫–æ–Ω—Ü–∞ –ø–æ–¥–ø–∏—Å–∫–∏.','ok');
  }
}

/* ‚îÄ‚îÄ‚îÄ Manual save ‚îÄ‚îÄ‚îÄ */
async function saveNotif(){
  const date=document.getElementById('np-date').value;
  if(!date){showSt('‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É','warn');return;}

  let p=Notification.permission;
  if(p==='default') p=await Notification.requestPermission();
  if(p==='denied'){showSt('‚ùå –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –±—Ä–∞—É–∑–µ—Ä–æ–º','err');return;}

  const stored=loadStoredSub();
  stored.date=date;
  stored.totalDays=stored.totalDays||30;
  stored.savedAt=Date.now();
  saveStoredSub(stored);

  refreshHeaderStatus(stored);
  renderSyncCard();
  showSt('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ! –£–≤–µ–¥–æ–º–ª—é –∑–∞ 3 –¥–Ω—è –¥–æ –∫–æ–Ω—Ü–∞ –ø–æ–¥–ø–∏—Å–∫–∏.','ok');
  document.getElementById('bell-badge').classList.add('show');
  checkExpiry();
}

/* ‚îÄ‚îÄ‚îÄ Disable notifications ‚îÄ‚îÄ‚îÄ */
function disableNotif(){
  saveStoredSub({});
  refreshHeaderStatus({});
  renderSyncCard();
  document.getElementById('bell-badge').classList.remove('show');
  document.getElementById('np-date').value='';
  showSt('üîï –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã','warn');
}

/* ‚îÄ‚îÄ‚îÄ Test notification ‚îÄ‚îÄ‚îÄ */
async function testNotif(){
  let p=Notification.permission;
  if(p==='default') p=await Notification.requestPermission();
  if(p==='denied'){showSt('‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –±—Ä–∞—É–∑–µ—Ä–æ–º','err');return;}
  setTimeout(()=>{
    const n=new Notification('‚úÖ Weltkind ‚Äî —Ç–µ—Å—Ç',{
      body:'–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç! –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.',
      icon:'icons/icon-192.png',
      tag:'vpn-test'
    });
    n.onclick=()=>{window.focus();n.close();};
  },500);
  showSt('üì¨ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!','ok');
}

/* ‚îÄ‚îÄ‚îÄ Check expiry and show notification ‚îÄ‚îÄ‚îÄ */
function checkExpiry(){
  const s=loadStoredSub();
  if(!s || !s.date || Notification.permission!=='granted') return;

  const days=daysLeft(s.date);
  if(days===null) return;

  if(days<=3){
    const title=days<=0?'üö® –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞!':`‚ö†Ô∏è –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ ${days} –¥–Ω.`;
    const body=days<=0
      ?'–ü—Ä–æ–¥–ª–∏—Ç–µ VPN –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å! –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.'
      :'–û—Å—Ç–∞–ª–æ—Å—å —Å–æ–≤—Å–µ–º –Ω–µ–º–Ω–æ–≥–æ ‚Äî –∑–∞–π–¥–∏—Ç–µ –∏ –ø—Ä–æ–¥–ª–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É.';
    setTimeout(()=>{
      const n=new Notification(title,{
        body,
        icon:'icons/icon-192.png',
        tag:'vpn-expiry',
        renotify:true,
        vibrate:[200,100,200,100,200]
      });
      n.onclick=()=>{window.focus();n.close();};
    },1500);
    document.getElementById('bell-badge').classList.add('show');
  }
}

/* ‚îÄ‚îÄ‚îÄ Show status message ‚îÄ‚îÄ‚îÄ */
function showSt(msg,type){
  const e=document.getElementById('np-status');
  e.textContent=msg;
  e.className='np-status show '+type;
}

/* ‚îÄ‚îÄ‚îÄ On load: restore stored data ‚îÄ‚îÄ‚îÄ */
window.addEventListener('DOMContentLoaded',()=>{
  const s=loadStoredSub();
  if(s && s.date){
    refreshHeaderStatus(s);
    checkExpiry();
  }
  // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å
  setInterval(checkExpiry, 3600000);
  // –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 9:00 ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π check
  scheduleNextDayCheck();
});

/* ‚îÄ‚îÄ‚îÄ Schedule daily check ‚îÄ‚îÄ‚îÄ */
function scheduleNextDayCheck(){
  const now=new Date();
  const next=new Date(now);
  next.setHours(9,0,0,0);
  if(next<=now) next.setDate(next.getDate()+1);
  const delay=next-now;
  setTimeout(()=>{
    checkExpiry();
    scheduleNextDayCheck();
  }, delay);
}

/* ‚îÄ‚îÄ‚îÄ PWA install ‚îÄ‚îÄ‚îÄ */
let dp=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();dp=e;
  setTimeout(()=>document.getElementById('install-banner').classList.add('show'),4000);
});
document.getElementById('install-btn').onclick=async()=>{
  document.getElementById('install-banner').classList.remove('show');
  if(dp){dp.prompt();await dp.userChoice;dp=null;}
};
window.addEventListener('appinstalled',()=>document.getElementById('install-banner').classList.remove('show'));
</script>
</body>
</html>
