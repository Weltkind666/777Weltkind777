<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta name="theme-color" content="#050d14"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="Weltkind"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="apple-touch-icon" href="icons/icon-192.png"/>
  <link rel="icon" href="icons/icon-192.png"/>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet"/>
  <title>Weltkind</title>
  <style>
    :root{--bg:#050d14;--surface:#0a1929;--card:#0d2137;--accent:#00e676;--accent2:#00b0ff;--warn:#ff6d00;--text:#e0f7fa;--muted:#546e7a;--border:rgba(0,230,118,.12);}
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;overflow:hidden;background:var(--bg);font-family:'Rajdhani',sans-serif;color:var(--text)}
    #bg-canvas{position:fixed;inset:0;z-index:0;opacity:.3}
    #splash{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .6s ease}
    #splash.out{opacity:0;pointer-events:none}
    .vpn-orb{position:relative;width:140px;height:140px;margin-bottom:28px}
    .orb-core{position:absolute;inset:30px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#00e676,#005f2d);box-shadow:0 0 40px rgba(0,230,118,.8);animation:op 2.5s ease-in-out infinite}
    .orb-ring{position:absolute;inset:0;border-radius:50%;border:2px solid rgba(0,230,118,.5);animation:re 2.5s ease-out infinite}
    .orb-ring:nth-child(2){animation-delay:.8s}
    .orb-ring:nth-child(3){animation-delay:1.6s}
    @keyframes op{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
    @keyframes re{0%{transform:scale(.6);opacity:.8}100%{transform:scale(1.7);opacity:0}}
    .splash-brand{font-size:2.2rem;font-weight:700;letter-spacing:.08em;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .splash-sub{margin-top:8px;font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--muted);letter-spacing:.15em}
    .splash-bar{margin-top:32px;width:160px;height:2px;background:rgba(0,230,118,.12);border-radius:2px;overflow:hidden}
    .splash-bar-fill{height:100%;width:0%;background:var(--accent);border-radius:2px;animation:bf 2.2s ease forwards}
    @keyframes bf{to{width:100%}}
    #hdr{position:fixed;top:0;left:0;right:0;height:52px;z-index:200;background:rgba(5,13,20,.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 16px}
    .hdr-brand{font-size:1.1rem;font-weight:700;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .hdr-right{display:flex;align-items:center;gap:10px}
    .conn-pill{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;background:rgba(0,230,118,.08);border:1px solid rgba(0,230,118,.2);font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--accent);cursor:pointer;transition:background .2s}
    .conn-pill:hover{background:rgba(0,230,118,.15)}
    .conn-dot{width:6px;height:6px;border-radius:50%;background:var(--warn);transition:background .4s,box-shadow .4s}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
    .conn-dot.blink{animation:blink 2s infinite}
    .bell-btn{position:relative;width:36px;height:36px;border-radius:10px;background:rgba(0,176,255,.08);border:1px solid rgba(0,176,255,.2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.1rem;transition:background .2s}
    .bell-btn:hover{background:rgba(0,176,255,.2)}
    .bell-badge{position:absolute;top:4px;right:4px;width:8px;height:8px;background:var(--warn);border-radius:50%;border:1px solid var(--bg);display:none}
    .bell-badge.show{display:block}
    #frame-wrap{position:fixed;top:52px;left:0;right:0;bottom:0;z-index:10}
    #main-frame{width:100%;height:100%;border:none;display:block;opacity:0;transition:opacity .5s}
    #main-frame.loaded{opacity:1}
    /* Panel */
    #notif-panel{position:fixed;top:60px;right:12px;z-index:500;width:min(320px,92vw);background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 16px 48px rgba(0,0,0,.7);transform:translateY(-20px) scale(.95);opacity:0;pointer-events:none;transition:all .3s cubic-bezier(.34,1.56,.64,1)}
    #notif-panel.open{transform:translateY(0) scale(1);opacity:1;pointer-events:all}
    .np-title{font-size:1rem;font-weight:700;margin-bottom:14px}
    .np-label{font-family:'JetBrains Mono',monospace;font-size:.63rem;color:var(--muted);letter-spacing:.1em;margin-bottom:6px;text-transform:uppercase}
    .np-section{margin-bottom:12px}
    .np-input{width:100%;padding:9px 12px;border-radius:9px;background:rgba(0,230,118,.05);border:1px solid var(--border);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.8rem;outline:none;transition:border .2s}
    .np-input:focus{border-color:var(--accent)}
    .np-btn{width:100%;padding:10px;border-radius:10px;border:none;font-family:'Rajdhani',sans-serif;font-size:.95rem;font-weight:700;cursor:pointer;transition:all .2s;margin-bottom:8px}
    .np-btn-green{background:linear-gradient(135deg,var(--accent),#00b300);color:#000}
    .np-btn-green:hover{box-shadow:0 0 20px rgba(0,230,118,.4);transform:translateY(-1px)}
    .np-btn-blue{background:rgba(0,176,255,.1);border:1px solid rgba(0,176,255,.25);color:var(--accent2)}
    .np-btn-red{background:rgba(255,23,68,.08);border:1px solid rgba(255,23,68,.25);color:#ff6b6b}
    /* Sync card */
    .sync-card{border-radius:12px;padding:12px 14px;margin-bottom:10px;border:1px solid var(--border);background:rgba(255,255,255,.03)}
    .sync-card.ok{border-color:rgba(0,230,118,.4);background:rgba(0,230,118,.06)}
    .sync-card.warn{border-color:rgba(255,109,0,.4);background:rgba(255,109,0,.06)}
    .sync-card.err{border-color:rgba(255,23,68,.4);background:rgba(255,23,68,.06)}
    .sc-row{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:5px;font-size:.85rem}
    .sc-row:last-child{margin-bottom:0}
    .sc-lbl{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--muted);text-transform:uppercase}
    .sc-val{font-weight:700}
    .sync-card.ok .sc-val{color:var(--accent)}
    .sync-card.warn .sc-val{color:var(--warn)}
    .sync-card.err .sc-val{color:#ff5252}
    .sub-bar{height:3px;border-radius:2px;background:rgba(255,255,255,.07);margin-top:8px;overflow:hidden}
    .sub-bar-fill{height:100%;border-radius:2px;transition:width .8s ease,background .4s}
    .np-hint{font-family:'JetBrains Mono',monospace;font-size:.66rem;color:var(--muted);text-align:center;margin:8px 0;line-height:1.5}
    .np-divider{height:1px;background:var(--border);margin:10px 0}
    .np-status{font-family:'JetBrains Mono',monospace;font-size:.72rem;margin-top:8px;padding:8px 10px;border-radius:8px;background:rgba(0,230,118,.05);border:1px solid var(--border);display:none}
    .np-status.show{display:block}
    .np-status.ok{color:var(--accent);border-color:rgba(0,230,118,.3)}
    .np-status.warn{color:var(--warn);border-color:rgba(255,109,0,.3)}
    .np-status.err{color:#ff1744;border-color:rgba(255,23,68,.3)}
    /* Install banner */
    #install-banner{display:none;position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:var(--card);border:1px solid rgba(0,230,118,.25);border-radius:14px;padding:12px 16px;flex-direction:row;align-items:center;gap:12px;z-index:400;box-shadow:0 8px 32px rgba(0,0,0,.6);min-width:260px;max-width:90vw;animation:su .4s cubic-bezier(.34,1.56,.64,1)}
    @keyframes su{from{transform:translateX(-50%) translateY(80px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
    #install-banner.show{display:flex}
    .ib-icon{font-size:1.7rem}.ib-text{flex:1}
    .ib-text strong{display:block;font-size:.95rem;font-weight:700}
    .ib-text span{font-size:.7rem;color:var(--muted);font-family:'JetBrains Mono',monospace}
    .ib-install{padding:8px 16px;background:linear-gradient(135deg,var(--accent),#00b300);border:none;border-radius:100px;color:#000;font-family:'Rajdhani',sans-serif;font-size:.85rem;font-weight:700;cursor:pointer}
    .ib-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:1rem}
    #dimmer{position:fixed;inset:0;z-index:450;background:rgba(0,0,0,.5);display:none;backdrop-filter:blur(2px)}
    #dimmer.show{display:block}
  </style>
</head>
<body>
<canvas id="bg-canvas"></canvas>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ONBOARDING (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è 1 —Ä–∞–∑) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="onboarding">
  <div class="ob-slide active">
    <div class="ob-emoji">‚ö°</div>
    <div class="ob-title">Weltkind VPN</div>
    <div class="ob-desc">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!<br><br>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞—à–µ–π <strong>VPN-–ø–æ–¥–ø–∏—Å–∫–æ–π</strong> ‚Äî –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ –ø—Ä—è–º–æ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞.</div>
  </div>
  <div class="ob-slide">
    <div class="ob-emoji">üì±</div>
    <div class="ob-title">–í–æ–π–¥–∏—Ç–µ –ø–æ –Ω–æ–º–µ—Ä—É</div>
    <div class="ob-desc">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ <strong>79161234567</strong><br><br>–°–∏—Å—Ç–µ–º–∞ –Ω–∞–π–¥—ë—Ç –≤–∞—à—É –ø–æ–¥–ø–∏—Å–∫—É –∏ –ø–æ–∫–∞–∂–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã.</div>
  </div>
  <div class="ob-slide">
    <div class="ob-emoji">üîî</div>
    <div class="ob-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
    <div class="ob-desc">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <strong>üîî</strong> –≤ –ø—Ä–∞–≤–æ–º —É–≥–ª—É –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ Telegram-–±–æ—Ç–∞.<br><br>–í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ <strong>–∑–∞ 3 –¥–Ω—è</strong> –¥–æ –∫–æ–Ω—Ü–∞ –ø–æ–¥–ø–∏—Å–∫–∏.</div>
  </div>
  <div class="ob-dots">
    <div class="ob-dot active"></div>
    <div class="ob-dot"></div>
    <div class="ob-dot"></div>
  </div>
  <button class="ob-btn" id="ob-next-btn" onclick="obNext()">–î–∞–ª–µ–µ ‚Üí</button>
  <button class="ob-skip" onclick="obFinish()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
</div>

<div id="splash">
  <div class="vpn-orb">
    <div class="orb-ring"></div><div class="orb-ring"></div><div class="orb-ring"></div>
    <div class="orb-core"></div>
  </div>
  <div class="splash-brand">WELTKIND</div>
  <div class="splash-sub">SECURE ¬∑ PRIVATE ¬∑ FAST</div>
  <div class="splash-bar"><div class="splash-bar-fill"></div></div>
</div>

<header id="hdr">
  <div class="hdr-brand">‚ö° Weltkind</div>
  <div class="hdr-right">
    <div class="conn-pill" onclick="togglePanel()" title="–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏">
      <div class="conn-dot blink" id="conn-dot"></div>
      <span id="conn-text">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
    </div>
    <div class="bell-btn" onclick="togglePanel()">üîî
      <div class="bell-badge" id="bell-badge"></div>
    </div>
  </div>
</header>

<div id="dimmer" onclick="closePanel()"></div>

<div id="notif-panel">
  <div class="np-title">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–µ</div>

  <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ (–∞–≤—Ç–æ-—Å–∏–Ω–∫) -->
  <div id="sync-card" class="sync-card">
    <div class="sc-row"><span class="sc-lbl">–°–¢–ê–¢–£–°</span><span class="sc-val" id="sc-status">‚Äî</span></div>
    <div class="sc-row"><span class="sc-lbl">–ò–°–¢–ï–ö–ê–ï–¢</span><span class="sc-val" id="sc-expiry">‚Äî</span></div>
    <div class="sc-row"><span class="sc-lbl">–û–°–¢–ê–õ–û–°–¨</span><span class="sc-val" id="sc-days">‚Äî</span></div>
    <div class="sub-bar"><div class="sub-bar-fill" id="sub-fill" style="width:0%"></div></div>
  </div>

  <div id="np-hint" class="np-hint">‚¨áÔ∏è –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>

  <div class="np-divider"></div>

  <!-- –†—É—á–Ω–æ–π –≤–≤–æ–¥ -->
  <div class="np-section">
    <div class="np-label">–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤—Ä—É—á–Ω—É—é</div>
    <input type="date" id="np-date" class="np-input"/>
  </div>
  <button class="np-btn np-btn-green" onclick="saveNotif()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤–∫–ª—é—á–∏—Ç—å</button>
  <button class="np-btn np-btn-blue" onclick="shareApp()">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º</button>
  <button class="np-btn np-btn-blue" onclick="testNotif()">üß™ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
  <button class="np-btn np-btn-red" id="notif-off-btn" onclick="disableNotif()" style="display:none">üîï –û—Ç–∫–ª—é—á–∏—Ç—å</button>

  <div id="np-status" class="np-status"></div>
</div>

<div id="frame-wrap">
  <iframe id="main-frame"
    src="https://script.google.com/macros/s/AKfycbxfUBsBIMK6qULmIlqfxoOR9bWtjmc4uofYt3jWjGMd0Ql8kL4u32a7I9cgl22N3pJt8g/exec"
    title="Weltkind"
    sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-top-navigation allow-modals">
  </iframe>
</div>

<div id="install-banner">
  <div class="ib-icon">üì≤</div>
  <div class="ib-text"><strong>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</strong><span>–†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –Ω–∞—Ç–∏–≤–Ω–æ–µ</span></div>
  <button class="ib-install" id="install-btn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
  <button class="ib-close" onclick="document.getElementById('install-banner').classList.remove('show')">‚úï</button>
</div>

<script>
/* ‚îÄ‚îÄ Matrix canvas ‚îÄ‚îÄ */
(function(){
  const c=document.getElementById('bg-canvas'),ctx=c.getContext('2d');
  let cols,drops;const chars='01„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±';
  function resize(){c.width=innerWidth;c.height=innerHeight;cols=Math.floor(c.width/18);drops=Array(cols).fill(1);}
  function draw(){ctx.fillStyle='rgba(5,13,20,.06)';ctx.fillRect(0,0,c.width,c.height);ctx.fillStyle='#00e676';ctx.font='13px monospace';for(let i=0;i<drops.length;i++){ctx.fillText(chars[Math.floor(Math.random()*chars.length)],i*18,drops[i]*18);if(drops[i]*18>c.height&&Math.random()>.975)drops[i]=0;drops[i]++;}}
  resize();window.addEventListener('resize',resize);setInterval(draw,55);
})();

/* ‚îÄ‚îÄ Constants ‚îÄ‚îÄ */
const APPS_SCRIPT_URL='https://script.google.com/macros/s/AKfycbxfUBsBIMK6qULmIlqfxoOR9bWtjmc4uofYt3jWjGMd0Ql8kL4u32a7I9cgl22N3pJt8g/exec';

/* ‚îÄ‚îÄ Iframe load ‚îÄ‚îÄ */
const frame=document.getElementById('main-frame');
const dot=document.getElementById('conn-dot');
const txt=document.getElementById('conn-text');
let splashTimer=setTimeout(()=>{
  document.getElementById('splash').classList.add('out');
  txt.textContent='–º–µ–¥–ª–µ–Ω–Ω–æ';
},9000);

frame.addEventListener('load',()=>{
  clearTimeout(splashTimer);
  frame.classList.add('loaded');
  setTimeout(()=>document.getElementById('splash').classList.add('out'),400);
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ localStorage
  applyStoredSub(loadSub());
  checkExpiry();
});

/* ‚îÄ‚îÄ SW ‚îÄ‚îÄ */
if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});

/* ‚îÄ‚îÄ localStorage ‚îÄ‚îÄ */
function loadSub(){try{return JSON.parse(localStorage.getItem('vpn_s')||'{}')||{};}catch(e){return{};}}
function saveSub(o){localStorage.setItem('vpn_s',JSON.stringify(o));}

/* ‚îÄ‚îÄ Date helpers ‚îÄ‚îÄ */
function toISO(str){
  if(!str||str==='–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'||str==='–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ') return null;
  const p=str.split('.');
  if(p.length===3) return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
  const d=new Date(str);
  return isNaN(d)?null:d.toISOString().slice(0,10);
}
function daysLeft(iso){
  if(!iso) return null;
  return Math.ceil((new Date(iso)-Date.now())/86400000);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ‚òÖ –ú–ï–¢–û–î 1: postMessage –æ—Ç iframe (Apps Script)
     Apps Script —à–ª—ë—Ç: window.top.postMessage({type:'weltkind_sub',...})
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.addEventListener('message',function(e){
  if(!e.data||e.data.type!=='weltkind_sub') return;
  console.log('[PWA] postMessage –ø–æ–ª—É—á–µ–Ω –æ—Ç iframe:', e.data);
  handleSubData(e.data.expiryDate, e.data.status, e.data.phone, 'postMessage');
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ‚òÖ –ú–ï–¢–û–î 2: MutationObserver ‚Äî –Ω–∞–±–ª—é–¥–∞–µ–º –∑–∞
     iframe URL —á–µ—Ä–µ–∑ hash-—Ç—Ä—é–∫ (fallback)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// –°–ª—É—à–∞–µ–º hashchange –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ –∏–∑ iframe —á–µ—Ä–µ–∑ allow-top-navigation
window.addEventListener('hashchange',function(){
  const hash=location.hash;
  if(hash.startsWith('#wpwa:')){
    try{
      const data=JSON.parse(decodeURIComponent(hash.slice(6)));
      if(data.type==='sub') handleSubData(data.expiryDate,data.status,data.phone,'hash');
    }catch(e){}
    history.replaceState(null,'',location.pathname+location.search);
  }
});

/* ‚îÄ‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∫–∏ (–µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞) ‚îÄ‚îÄ */
function handleSubData(expiryDate, status, phone, source){
  console.log('[PWA] handleSubData source='+source, expiryDate, status, phone);
  const iso=toISO(expiryDate);
  if(!iso && status!=='–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ') return; // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –º—É—Å–æ—Ä

  const prev=loadSub();
  // totalDays ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –¥–Ω–µ–π (–∑–∞—Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–ª—É—á–µ–Ω–∏–∏)
  let totalDays=prev.totalDays||30;
  if(iso){const d=daysLeft(iso);if(d&&d>totalDays)totalDays=d;}

  const sub={date:iso,displayDate:expiryDate,status,phone,totalDays,syncedAt:Date.now()};
  saveSub(sub);
  applyStoredSub(sub);
  checkExpiry();
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
  if(iso && status==='–û–ø–ª–∞—á–µ–Ω–æ') autoAskPermission();
}

/* ‚îÄ‚îÄ –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–ø–∫—É –∏ –∫–∞—Ä—Ç–æ—á–∫—É ‚îÄ‚îÄ */
function applyStoredSub(sub){
  if(!sub||!sub.date){
    dot.className='conn-dot blink';
    dot.style.background='var(--warn)';
    dot.style.boxShadow='';
    txt.textContent='–≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç';
    return;
  }
  const days=daysLeft(sub.date);
  dot.classList.remove('blink');
  if(days===null){
    txt.textContent='‚Äî';
    dot.style.background='var(--muted)';
  } else if(days<=0){
    dot.style.background='#ff1744';
    dot.style.boxShadow='0 0 8px #ff1744';
    txt.textContent='–∏—Å—Ç–µ–∫–ª–∞!';
    document.getElementById('bell-badge').classList.add('show');
  } else if(days<=3){
    dot.style.background='var(--warn)';
    dot.style.boxShadow='0 0 8px var(--warn)';
    dot.classList.add('blink');
    txt.textContent=days+' –¥–Ω.';
    document.getElementById('bell-badge').classList.add('show');
  } else {
    dot.style.background='var(--accent)';
    dot.style.boxShadow='0 0 8px var(--accent)';
    txt.textContent=days+' –¥–Ω.';
  }
}

/* ‚îÄ‚îÄ –ö–∞—Ä—Ç–æ—á–∫–∞ –≤ –ø–∞–Ω–µ–ª–∏ ‚îÄ‚îÄ */
function renderSyncCard(){
  const sub=loadSub();
  const card=document.getElementById('sync-card');
  const hint=document.getElementById('np-hint');
  const offBtn=document.getElementById('notif-off-btn');
  const fill=document.getElementById('sub-fill');

  if(!sub||!sub.date){
    card.className='sync-card';
    document.getElementById('sc-status').textContent='–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
    document.getElementById('sc-expiry').textContent='‚Äî';
    document.getElementById('sc-days').textContent='‚Äî';
    fill.style.width='0%';
    hint.style.display='block';
    offBtn.style.display='none';
    return;
  }
  hint.style.display='none';
  offBtn.style.display='block';
  document.getElementById('sc-expiry').textContent=new Date(sub.date).toLocaleDateString('ru-RU');
  const days=daysLeft(sub.date);
  if(days===null){card.className='sync-card';return;}
  if(days<=0){
    card.className='sync-card err';
    document.getElementById('sc-status').textContent='‚ùå –∏—Å—Ç–µ–∫–ª–∞';
    document.getElementById('sc-days').textContent=Math.abs(days)+' –¥–Ω. –Ω–∞–∑–∞–¥';
    fill.style.width='100%';fill.style.background='#ff1744';
  } else if(days<=3){
    card.className='sync-card warn';
    document.getElementById('sc-status').textContent='‚ö†Ô∏è —Å–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç';
    document.getElementById('sc-days').textContent=days+' –¥–Ω.';
    fill.style.width=Math.round((3-days)/3*100)+'%';fill.style.background='var(--warn)';
  } else {
    card.className='sync-card ok';
    document.getElementById('sc-status').textContent='‚úÖ –∞–∫—Ç–∏–≤–Ω–∞';
    document.getElementById('sc-days').textContent=days+' –¥–Ω.';
    const pct=Math.max(5,Math.min(100,Math.round(days/(sub.totalDays||30)*100)));
    fill.style.width=pct+'%';fill.style.background='var(--accent)';
  }
  if(Notification.permission==='granted') document.getElementById('bell-badge').classList.add('show');
}

/* ‚îÄ‚îÄ Panel ‚îÄ‚îÄ */
function togglePanel(){
  const p=document.getElementById('notif-panel'),d=document.getElementById('dimmer');
  if(p.classList.contains('open')){closePanel();}
  else{
    p.classList.add('open');d.classList.add('show');
    renderSyncCard();
    const s=loadSub();
    if(s.date) document.getElementById('np-date').value=s.date;
  }
}
function closePanel(){
  document.getElementById('notif-panel').classList.remove('open');
  document.getElementById('dimmer').classList.remove('show');
}

/* ‚îÄ‚îÄ Auto permission ‚îÄ‚îÄ */
async function autoAskPermission(){
  if(Notification.permission==='default'){
    const p=await Notification.requestPermission();
    if(p==='granted'){
      showSt('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã! –£–≤–µ–¥–æ–º–ª—é –∑–∞ 3 –¥–Ω—è –¥–æ –∫–æ–Ω—Ü–∞ –ø–æ–¥–ø–∏—Å–∫–∏.','ok');
      document.getElementById('bell-badge').classList.add('show');
    }
  }
}

/* ‚îÄ‚îÄ Manual save ‚îÄ‚îÄ */
async function saveNotif(){
  const date=document.getElementById('np-date').value;
  if(!date){showSt('‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É','warn');return;}
  let p=Notification.permission;
  if(p==='default') p=await Notification.requestPermission();
  if(p==='denied'){showSt('‚ùå –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –±—Ä–∞—É–∑–µ—Ä–æ–º','err');return;}
  const sub=loadSub();
  sub.date=date;sub.totalDays=sub.totalDays||30;sub.savedAt=Date.now();
  saveSub(sub);
  applyStoredSub(sub);
  renderSyncCard();
  showSt('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ! –£–≤–µ–¥–æ–º–ª—é –∑–∞ 3 –¥–Ω—è –¥–æ –∫–æ–Ω—Ü–∞ –ø–æ–¥–ø–∏—Å–∫–∏.','ok');
  document.getElementById('bell-badge').classList.add('show');
  checkExpiry();
}

function disableNotif(){
  saveSub({});applyStoredSub({});renderSyncCard();
  document.getElementById('bell-badge').classList.remove('show');
  document.getElementById('np-date').value='';
  showSt('üîï –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã','warn');
}

/* ‚îÄ‚îÄ Test notification ‚îÄ‚îÄ */
async function testNotif(){
  let p=Notification.permission;
  if(p==='default') p=await Notification.requestPermission();
  if(p==='denied'){showSt('‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –±—Ä–∞—É–∑–µ—Ä–æ–º','err');return;}
  setTimeout(()=>{
    const n=new Notification('‚úÖ Weltkind ‚Äî —Ç–µ—Å—Ç',{
      body:'–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç! –î–∞–Ω–Ω—ã–µ –æ –ø–æ–¥–ø–∏—Å–∫–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.',
      icon:'icons/icon-192.png',tag:'vpn-test'
    });
    n.onclick=()=>{window.focus();n.close();};
  },500);
  showSt('üì¨ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!','ok');
}

/* ‚îÄ‚îÄ Check expiry & push notification ‚îÄ‚îÄ */
function checkExpiry(){
  const sub=loadSub();
  if(!sub.date||Notification.permission!=='granted') return;
  const days=daysLeft(sub.date);
  if(days===null||days>3) return;
  const title=days<=0?'üö® –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞!':`‚ö†Ô∏è –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ ${days} –¥–Ω.`;
  const body=days<=0?'–ü—Ä–æ–¥–ª–∏—Ç–µ VPN –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!':'–ó–∞–π–¥–∏—Ç–µ –∏ –ø—Ä–æ–¥–ª–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É.';
  setTimeout(()=>{
    const n=new Notification(title,{body,icon:'icons/icon-192.png',tag:'vpn-expiry',renotify:true,vibrate:[200,100,200]});
    n.onclick=()=>{window.focus();n.close();};
  },1500);
  document.getElementById('bell-badge').classList.add('show');
}

function showSt(msg,type){
  const e=document.getElementById('np-status');e.textContent=msg;e.className='np-status show '+type;
}

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
document.addEventListener('DOMContentLoaded',()=>{
  const sub=loadSub();
  if(sub.date){applyStoredSub(sub);checkExpiry();}
  setInterval(checkExpiry,3600000);
});

/* ‚îÄ‚îÄ PWA install ‚îÄ‚îÄ */
let dp=null;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();dp=e;setTimeout(()=>document.getElementById('install-banner').classList.add('show'),4000);});
document.getElementById('install-btn').onclick=async()=>{document.getElementById('install-banner').classList.remove('show');if(dp){dp.prompt();await dp.userChoice;dp=null;}};
window.addEventListener('appinstalled',()=>document.getElementById('install-banner').classList.remove('show'));
</script>
</body>
</html>
